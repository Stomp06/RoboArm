#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>
#include <WiFi.h>
#include <WebServer.h>

// --- WIFI SETTINGS ---
const char* ssid = "YOUR_WIFI_NAME";
const char* password = "YOUR_WIFI_PASSWORD";

// --- SERVO SETTINGS ---
Adafruit_PWMServoDriver pwm(0x40);
WebServer server(80);

#define SERVO_FREQ 50
#define SERVO_MIN 150 
#define SERVO_MAX 600 

// --- Servo Channels (0-3) ---
#define SERVO_BASE     0 
#define SERVO_SHOULDER 1 
#define SERVO_ELBOW    2 // Previously Mirrored, now Independent
#define SERVO_GRIPPER  3 

// --- Speed & Step Settings ---
const int SPEED_DELAY = 15; // Higher = Slower movement
const int STEP_ANGLE = 20;  // Angle change per click

// --- Current Positions (Tracked in Software) ---
int posBase = 90;
int posShoulder = 90;
int posElbow = 90;
int posGripper = 90; // 90 = Open, 180 = Closed (depends on assembly)

// --- HELPER FUNCTIONS ---

int angleToPulse(int ang) {
  return map(ang, 0, 180, SERVO_MIN, SERVO_MAX);
}

// Universal Move Function
void moveServoSlow(int channel, int startPos, int targetPos) {
  if (startPos == targetPos) return;
  int step = (targetPos > startPos) ? 1 : -1;
  
  for (int i = startPos; i != targetPos; i += step) {
    pwm.setPWM(channel, 0, angleToPulse(i));
    delay(SPEED_DELAY);
  }
  pwm.setPWM(channel, 0, angleToPulse(targetPos));
}

// --- WEB HANDLERS ---

void handleRoot() {
  String html = "<html><head><style>";
  html += "body { font-family: sans-serif; text-align: center; margin-top: 50px; }";
  html += "button { font-size: 1.5rem; padding: 15px 30px; margin: 10px; border-radius: 10px; }";
  html += "h1 { color: #333; } p { font-size: 1.2rem; }";
  html += "</style></head><body>";
  
  html += "<h1>Robotic Arm Control</h1>";

  // Base Controls
  html += "<p><b>Base (" + String(posBase) + ")</b></p>";
  html += "<a href=\"/base_left\"><button>Left</button></a>";
  html += "<a href=\"/base_right\"><button>Right</button></a>";
  html += "<hr>";

  // Shoulder Controls
  html += "<p><b>Shoulder (" + String(posShoulder) + ")</b></p>";
  html += "<a href=\"/shoulder_up\"><button>Up</button></a>";
  html += "<a href=\"/shoulder_down\"><button>Down</button></a>";
  html += "<hr>";

  // Elbow Controls
  html += "<p><b>Elbow (" + String(posElbow) + ")</b></p>";
  html += "<a href=\"/elbow_up\"><button>Up</button></a>";
  html += "<a href=\"/elbow_down\"><button>Down</button></a>";
  html += "<hr>";

  // Gripper Controls
  html += "<p><b>Gripper (" + String(posGripper) + ")</b></p>";
  html += "<a href=\"/gripper_open\"><button>Open</button></a>";
  html += "<a href=\"/gripper_close\"><button>Close</button></a>";

  html += "</body></html>";
  server.send(200, "text/html", html);
}

// --- MOVEMENT HANDLERS ---

// 1. BASE
void handleBaseLeft() {
  int target = constrain(posBase + STEP_ANGLE, 0, 180);
  moveServoSlow(SERVO_BASE, posBase, target);
  posBase = target;
  server.sendHeader("Location", "/"); server.send(303);
}
void handleBaseRight() {
  int target = constrain(posBase - STEP_ANGLE, 0, 180);
  moveServoSlow(SERVO_BASE, posBase, target);
  posBase = target;
  server.sendHeader("Location", "/"); server.send(303);
}

// 2. SHOULDER
void handleShoulderUp() {
  int target = constrain(posShoulder + STEP_ANGLE, 0, 180);
  moveServoSlow(SERVO_SHOULDER, posShoulder, target);
  posShoulder = target;
  server.sendHeader("Location", "/"); server.send(303);
}
void handleShoulderDown() {
  int target = constrain(posShoulder - STEP_ANGLE, 0, 180);
  moveServoSlow(SERVO_SHOULDER, posShoulder, target);
  posShoulder = target;
  server.sendHeader("Location", "/"); server.send(303);
}

// 3. ELBOW
void handleElbowUp() {
  int target = constrain(posElbow + STEP_ANGLE, 0, 180);
  moveServoSlow(SERVO_ELBOW, posElbow, target);
  posElbow = target;
  server.sendHeader("Location", "/"); server.send(303);
}
void handleElbowDown() {
  int target = constrain(posElbow - STEP_ANGLE, 0, 180);
  moveServoSlow(SERVO_ELBOW, posElbow, target);
  posElbow = target;
  server.sendHeader("Location", "/"); server.send(303);
}

// 4. GRIPPER
void handleGripperOpen() {
  int target = constrain(posGripper + STEP_ANGLE, 0, 180);
  moveServoSlow(SERVO_GRIPPER, posGripper, target);
  posGripper = target;
  server.sendHeader("Location", "/"); server.send(303);
}
void handleGripperClose() {
  int target = constrain(posGripper - STEP_ANGLE, 0, 180);
  moveServoSlow(SERVO_GRIPPER, posGripper, target);
  posGripper = target;
  server.sendHeader("Location", "/"); server.send(303);
}

void setup() {
  Serial.begin(115200);
  
  // Hardware Init
  Wire.begin();
  pwm.begin();
  pwm.setOscillatorFrequency(27000000);
  pwm.setPWMFreq(SERVO_FREQ);

  // Set Start Positions
  pwm.setPWM(SERVO_BASE, 0, angleToPulse(posBase));
  pwm.setPWM(SERVO_SHOULDER, 0, angleToPulse(posShoulder));
  pwm.setPWM(SERVO_ELBOW, 0, angleToPulse(posElbow));
  pwm.setPWM(SERVO_GRIPPER, 0, angleToPulse(posGripper));

  // WiFi Init
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500); Serial.print(".");
  }
  Serial.println("\nWiFi Connected!");
  Serial.println(WiFi.localIP());

  // Define URL Routes
  server.on("/", handleRoot);
  server.on("/base_left", handleBaseLeft);
  server.on("/base_right", handleBaseRight);
  server.on("/shoulder_up", handleShoulderUp);
  server.on("/shoulder_down", handleShoulderDown);
  server.on("/elbow_up", handleElbowUp);
  server.on("/elbow_down", handleElbowDown);
  server.on("/gripper_open", handleGripperOpen);
  server.on("/gripper_close", handleGripperClose);
  
  server.begin();
}

void loop() {
  server.handleClient();
}
